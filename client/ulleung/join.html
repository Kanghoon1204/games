<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#f8fafc">
  <title>ìš¸ë¦‰ í•œ ì ‘ì‹œ - ì°¸ê°€</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    * { font-family: 'Noto Sans KR', sans-serif; -webkit-tap-highlight-color: transparent; }
    .btn { transition: all 0.2s; }
    .btn:active { transform: scale(0.97); }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
    .card { background: white; border-radius: 1rem; box-shadow: 0 1px 3px rgba(0,0,0,0.08); }
    .input-focus:focus { outline: none; border-color: #6366f1; box-shadow: 0 0 0 3px rgba(99,102,241,0.1); }
    .badge { font-size: 0.7rem; padding: 0.25rem 0.5rem; border-radius: 9999px; }
  </style>
</head>
<body class="bg-slate-50 text-slate-900 min-h-screen">
  <div class="max-w-md mx-auto p-4 pb-8">

    <!-- í—¤ë” -->
    <header class="flex items-center justify-between py-4">
      <a href="room.html" class="flex items-center gap-2">
        <span class="text-2xl">ğŸ½ï¸</span>
        <h1 class="text-xl font-bold">ìš¸ë¦‰ í•œ ì ‘ì‹œ</h1>
      </a>
      <div id="badge" class="badge bg-slate-200 text-slate-600">ì—°ê²° ì¤‘...</div>
    </header>

    <!-- ì°¸ê°€ í¼ -->
    <div id="view-join" class="space-y-4">
      <section class="card p-6">
        <div class="text-center mb-6">
          <div class="text-4xl mb-2">ğŸ®</div>
          <h2 class="font-bold text-xl mb-1">ë°© ì°¸ê°€</h2>
          <div class="inline-block bg-slate-100 rounded-lg px-3 py-1">
            <span class="text-sm text-slate-500">ë°© ì½”ë“œ:</span>
            <span id="roomIdDisplay" class="font-bold ml-1"></span>
          </div>
        </div>

        <div class="space-y-4">
          <div>
            <label class="text-sm text-slate-600 block mb-1">ë‹‰ë„¤ì„</label>
            <input id="playerName" type="text" placeholder="ì˜ˆ: íƒí—˜ê°€" maxlength="10"
              class="input-focus w-full border border-slate-200 rounded-lg px-4 py-3 text-base text-center">
          </div>

          <button id="btnJoin" class="btn w-full bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg px-4 py-3 font-medium">
            ì…ì¥í•˜ê¸°
          </button>
        </div>

        <p class="text-xs text-slate-400 mt-4 text-center">3~8ëª… í”Œë ˆì´ Â· ì¤‘ë³µ ë‹‰ë„¤ì„ ë¶ˆê°€</p>
        <div id="errJoin" class="hidden mt-3 p-3 rounded-lg bg-red-50 text-red-600 text-sm text-center"></div>
      </section>

      <a href="room.html" class="block text-center text-sm text-slate-500 hover:text-slate-700">
        â† ë°© ëª©ë¡ìœ¼ë¡œ
      </a>
    </div>

    <!-- ëŒ€ê¸°ì‹¤ -->
    <div id="view-lobby" class="hidden space-y-4">
      <section class="card p-6">
        <div class="flex items-center justify-between mb-4">
          <h2 class="font-bold text-lg">ëŒ€ê¸°ì‹¤</h2>
          <div class="text-sm">
            <span id="count" class="font-bold text-indigo-600">0</span> / 8ëª…
          </div>
        </div>

        <div class="bg-slate-100 rounded-lg p-3 mb-4 text-center">
          <div class="text-xs text-slate-500">ë°© ì½”ë“œ</div>
          <div id="lobbyRoom" class="font-bold"></div>
        </div>

        <ul id="playerList" class="space-y-1 mb-4"></ul>

        <div id="waiting" class="text-center py-4">
          <div class="inline-block animate-spin w-6 h-6 border-2 border-indigo-600 border-t-transparent rounded-full mb-2"></div>
          <p class="text-sm text-slate-500">ë°©ì¥ì´ ê²Œì„ì„ ì‹œì‘í•  ë•Œê¹Œì§€ ëŒ€ê¸° ì¤‘...</p>
        </div>

        <div id="started" class="hidden text-center py-4">
          <div class="text-2xl mb-2">ğŸ‰</div>
          <p class="text-emerald-600 font-medium mb-3">ê²Œì„ì´ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤!</p>
          <button id="goGame" class="btn bg-emerald-600 hover:bg-emerald-700 text-white rounded-lg px-6 py-2">
            ê²Œì„ í™”ë©´ìœ¼ë¡œ ì´ë™
          </button>
        </div>

        <button id="btnLeave" class="btn w-full mt-4 bg-slate-100 hover:bg-slate-200 text-slate-600 rounded-lg px-4 py-2 text-sm">
          ë‚˜ê°€ê¸°
        </button>
      </section>
    </div>

  </div>

  <script src="../firebase-config.js"></script>
  <script>
    const $ = s => document.querySelector(s);
    const show = (sel, yes) => $(sel).classList.toggle('hidden', !yes);

    const params = new URLSearchParams(location.search);
    const roomId = params.get('room') || '';

    if (!roomId) {
      alert('ì˜ëª»ëœ ë§í¬ì…ë‹ˆë‹¤.');
      location.href = 'room.html';
    }

    $('#roomIdDisplay').textContent = roomId;

    let myName = '';
    let myPlayerId = '';
    let roomRef = null;

    // ì—°ê²° ìƒíƒœ í™•ì¸
    db.ref('.info/connected').on('value', (snap) => {
      if (snap.val() === true) {
        $('#badge').textContent = 'ì—°ê²°ë¨';
        $('#badge').className = 'badge bg-emerald-100 text-emerald-700';
      } else {
        $('#badge').textContent = 'ì—°ê²° ëŠê¹€';
        $('#badge').className = 'badge bg-red-100 text-red-600';
      }
    });

    // ì°¸ê°€
    $('#btnJoin').onclick = async () => {
      const name = $('#playerName').value.trim();
      if (!name) {
        showError('ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”.');
        return;
      }

      // ë°© ì¡´ì¬ í™•ì¸
      const snap = await db.ref(`rooms/${roomId}`).once('value');
      if (!snap.exists()) {
        showError('ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ë°©ì…ë‹ˆë‹¤.');
        return;
      }

      const room = snap.val();

      // ê²Œì„ ì‹œì‘ë¨
      if (room.started) {
        showError('ì´ë¯¸ ê²Œì„ì´ ì‹œì‘ëœ ë°©ì…ë‹ˆë‹¤.');
        return;
      }

      // ì •ì› í™•ì¸
      const playerCount = Object.keys(room.players || {}).length;
      if (playerCount >= 8) {
        showError('ì •ì›ì´ ê°€ë“ ì°¼ìŠµë‹ˆë‹¤.');
        return;
      }

      // ë‹‰ë„¤ì„ ì¤‘ë³µ í™•ì¸
      const names = Object.values(room.players || {}).map(p => p.name);
      if (names.includes(name)) {
        showError('ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ë‹‰ë„¤ì„ì…ë‹ˆë‹¤.');
        return;
      }

      myName = name;
      myPlayerId = generatePlayerId();

      // í”Œë ˆì´ì–´ ì¶”ê°€
      await db.ref(`rooms/${roomId}/players/${myPlayerId}`).set({
        id: myPlayerId,
        name,
        balance: 1000000,
        hold: 0,
        items: [],
        readyPart: false,
        readyBid: false,
        willParticipate: null,
        joinedAt: firebase.database.ServerValue.TIMESTAMP
      });

      sessionStorage.setItem('roomId', roomId);
      sessionStorage.setItem('playerName', name);
      sessionStorage.setItem('playerId', myPlayerId);

      showLobby();
    };

    $('#playerName').onkeydown = (e) => {
      if (e.key === 'Enter') $('#btnJoin').click();
    };

    function showLobby() {
      show('#view-join', false);
      show('#view-lobby', true);
      $('#lobbyRoom').textContent = roomId;

      roomRef = db.ref(`rooms/${roomId}`);
      roomRef.on('value', (snap) => {
        if (!snap.exists()) {
          alert('ë°©ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
          sessionStorage.clear();
          location.href = 'room.html';
          return;
        }

        const room = snap.val();
        updatePlayerList(room);

        // ê²Œì„ ì‹œì‘ë¨
        if (room.started) {
          show('#waiting', false);
          show('#started', true);

          $('#goGame').onclick = () => {
            location.href = `game.html?room=${encodeURIComponent(roomId)}&name=${encodeURIComponent(myName)}`;
          };

          // 2ì´ˆ í›„ ìë™ ì´ë™
          setTimeout(() => {
            location.href = `game.html?room=${encodeURIComponent(roomId)}&name=${encodeURIComponent(myName)}`;
          }, 2000);
        }
      });
    }

    function updatePlayerList(room) {
      const players = Object.values(room.players || {});
      const ul = $('#playerList');
      ul.innerHTML = '';
      players.forEach(p => {
        const li = document.createElement('li');
        const isMe = p.name === myName;
        li.className = `flex items-center justify-between p-2 rounded-lg ${isMe ? 'bg-indigo-50' : 'bg-slate-50'}`;
        li.innerHTML = `
          <span>${p.name} ${isMe ? '<span class="text-xs text-indigo-500">(ë‚˜)</span>' : ''}</span>
          ${p.name === room.hostName ? '<span class="badge bg-amber-100 text-amber-700">ë°©ì¥</span>' : ''}
        `;
        ul.appendChild(li);
      });
      $('#count').textContent = players.length;
    }

    // ë‚˜ê°€ê¸°
    $('#btnLeave').onclick = async () => {
      if (roomRef) roomRef.off();
      if (myPlayerId) {
        await db.ref(`rooms/${roomId}/players/${myPlayerId}`).remove();
      }
      sessionStorage.clear();
      location.href = 'room.html';
    };

    function generatePlayerId() {
      return 'P' + Math.random().toString(36).substr(2, 9);
    }

    function showError(msg) {
      const el = $('#errJoin');
      el.textContent = msg;
      el.classList.remove('hidden');
      setTimeout(() => el.classList.add('hidden'), 3000);
    }

    // í¬ì»¤ìŠ¤
    $('#playerName').focus();
  </script>
</body>
</html>
