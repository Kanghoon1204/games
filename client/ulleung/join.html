<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>울릉 한 접시 - 참가</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <style>
    .mono { font-variant-numeric: tabular-nums; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
  </style>
</head>
<body class="bg-slate-50 text-slate-900 min-h-screen">
  <div class="max-w-xl mx-auto p-4 md:p-6 space-y-6">

    <header class="flex items-center justify-between">
      <h1 class="text-xl md:text-2xl font-bold">울릉 한 접시</h1>
      <span id="badge" class="text-xs px-2 py-1 rounded bg-slate-200">연결 중...</span>
    </header>

    <!-- 참가 폼 -->
    <section id="view-join" class="bg-white rounded-xl shadow p-4 md:p-6">
      <h2 class="font-semibold mb-4">참가하기</h2>
      <div class="text-sm mb-4">방: <span id="roomIdDisplay" class="mono font-bold"></span></div>

      <label class="text-sm block mb-1">닉네임</label>
      <input id="playerName" type="text" placeholder="예: 탐험가"
        class="w-full border rounded px-3 py-2 mb-4" maxlength="20">

      <button id="btnJoin" class="btn w-full bg-indigo-600 hover:bg-indigo-700 text-white rounded px-4 py-2">
        입장
      </button>
      <p class="text-xs text-slate-500 mt-3">정원: 3~8명. 중복 닉네임 불가.</p>
      <div id="errJoin" class="hidden mt-3 p-3 rounded bg-rose-50 border border-rose-200 text-rose-700 text-sm"></div>
    </section>

    <!-- 대기실 -->
    <section id="view-lobby" class="hidden bg-white rounded-xl shadow p-4 md:p-6">
      <div class="flex items-center justify-between mb-4">
        <h2 class="font-semibold">대기실</h2>
        <button id="btnLeave" class="btn bg-rose-600 text-white rounded px-3 py-2 text-sm">나가기</button>
      </div>
      <div class="text-sm mb-2">
        방: <span id="lobbyRoom" class="mono font-bold"></span>
        · <span id="count" class="font-bold">0</span> / 8명
      </div>
      <ul id="playerList" class="space-y-2 text-sm mb-4"></ul>

      <div id="started" class="hidden p-3 rounded bg-emerald-50 border border-emerald-200 text-emerald-700 text-sm">
        게임이 시작되었습니다!
        <button id="goGame" class="ml-2 underline">게임 화면으로</button>
      </div>
    </section>

  </div>

  <script>
    const $ = s => document.querySelector(s);
    const show = (sel, yes) => $(sel).classList.toggle('hidden', !yes);

    const params = new URLSearchParams(location.search);
    const roomId = params.get('room') || '';

    if (!roomId) {
      alert('잘못된 링크입니다.');
      location.href = 'room.html';
    }

    $('#roomIdDisplay').textContent = roomId;

    const serverUrl = location.hostname === 'localhost'
      ? 'http://localhost:3000'
      : location.origin;

    const socket = io(serverUrl);
    let myName = '';

    socket.on('connect', () => {
      $('#badge').textContent = '연결됨';
      $('#badge').className = 'text-xs px-2 py-1 rounded bg-emerald-600 text-white';
    });

    socket.on('disconnect', () => {
      $('#badge').textContent = '연결 끊김';
      $('#badge').className = 'text-xs px-2 py-1 rounded bg-rose-600 text-white';
    });

    socket.on('error', ({ message }) => {
      showError(message);
    });

    // 참가
    $('#btnJoin').onclick = () => {
      const name = $('#playerName').value.trim();
      if (!name) {
        showError('닉네임을 입력하세요.');
        return;
      }
      myName = name;
      socket.emit('room:join', { roomId, playerName: name });
    };

    $('#playerName').onkeydown = (e) => {
      if (e.key === 'Enter') $('#btnJoin').click();
    };

    // 참가 완료
    socket.on('room:joined', ({ roomId, room, playerName }) => {
      myName = playerName;
      sessionStorage.setItem('roomId', roomId);
      sessionStorage.setItem('playerName', playerName);

      show('#view-join', false);
      show('#view-lobby', true);
      $('#lobbyRoom').textContent = roomId;
      updatePlayerList(room.players);
    });

    // 방 상태 업데이트
    socket.on('room:updated', (room) => {
      updatePlayerList(room.players);
    });

    function updatePlayerList(players) {
      const ul = $('#playerList');
      ul.innerHTML = '';
      players.forEach((p, i) => {
        const li = document.createElement('li');
        li.className = 'border rounded px-3 py-2' + (p.name === myName ? ' bg-indigo-50' : '');
        li.textContent = `${i + 1}. ${p.name}` + (p.name === myName ? ' (나)' : '');
        ul.appendChild(li);
      });
      $('#count').textContent = players.length;
    }

    // 게임 시작됨
    socket.on('game:started', (room) => {
      show('#started', true);
      $('#goGame').onclick = () => {
        location.href = `game.html?room=${encodeURIComponent(room.id)}&name=${encodeURIComponent(myName)}`;
      };
      // 자동 이동
      setTimeout(() => {
        location.href = `game.html?room=${encodeURIComponent(room.id)}&name=${encodeURIComponent(myName)}`;
      }, 1000);
    });

    // 나가기
    $('#btnLeave').onclick = () => {
      socket.emit('room:leave');
      sessionStorage.clear();
      location.href = 'room.html';
    };

    // 방 삭제됨
    socket.on('room:deleted', () => {
      alert('방이 삭제되었습니다.');
      sessionStorage.clear();
      location.href = 'room.html';
    });

    function showError(msg) {
      const el = $('#errJoin');
      el.textContent = msg;
      el.classList.remove('hidden');
      setTimeout(() => el.classList.add('hidden'), 3000);
    }
  </script>
</body>
</html>
