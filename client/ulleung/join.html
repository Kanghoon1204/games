<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#f8fafc">
  <title>ìš¸ë¦‰ í•œ ì ‘ì‹œ - ì°¸ê°€</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    * { font-family: 'Noto Sans KR', sans-serif; -webkit-tap-highlight-color: transparent; }
    .btn { transition: all 0.2s; }
    .btn:active { transform: scale(0.97); }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
    .card { background: white; border-radius: 1rem; box-shadow: 0 1px 3px rgba(0,0,0,0.08); }
    .input-focus:focus { outline: none; border-color: #6366f1; box-shadow: 0 0 0 3px rgba(99,102,241,0.1); }
    .badge { font-size: 0.7rem; padding: 0.25rem 0.5rem; border-radius: 9999px; }
  </style>
</head>
<body class="bg-slate-50 text-slate-900 min-h-screen">
  <div class="max-w-md mx-auto p-4 pb-8">

    <!-- í—¤ë” -->
    <header class="flex items-center justify-between py-4">
      <a href="room.html" class="flex items-center gap-2">
        <span class="text-2xl">ğŸ½ï¸</span>
        <h1 class="text-xl font-bold">ìš¸ë¦‰ í•œ ì ‘ì‹œ</h1>
      </a>
      <div id="badge" class="badge bg-slate-200 text-slate-600">ì—°ê²° ì¤‘...</div>
    </header>

    <!-- ì°¸ê°€ í¼ -->
    <div id="view-join" class="space-y-4">
      <section class="card p-6">
        <div class="text-center mb-6">
          <div class="text-4xl mb-2">ğŸ®</div>
          <h2 class="font-bold text-xl mb-1">ë°© ì°¸ê°€</h2>
          <div class="inline-block bg-slate-100 rounded-lg px-3 py-1">
            <span class="text-sm text-slate-500">ë°© ì½”ë“œ:</span>
            <span id="roomIdDisplay" class="font-bold ml-1"></span>
          </div>
        </div>

        <div class="space-y-4">
          <div>
            <label class="text-sm text-slate-600 block mb-1">ë‹‰ë„¤ì„</label>
            <input id="playerName" type="text" placeholder="ì˜ˆ: íƒí—˜ê°€" maxlength="10"
              class="input-focus w-full border border-slate-200 rounded-lg px-4 py-3 text-base text-center">
          </div>

          <button id="btnJoin" class="btn w-full bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg px-4 py-3 font-medium">
            ì…ì¥í•˜ê¸°
          </button>
        </div>

        <p class="text-xs text-slate-400 mt-4 text-center">3~8ëª… í”Œë ˆì´ Â· ì¤‘ë³µ ë‹‰ë„¤ì„ ë¶ˆê°€</p>
        <div id="errJoin" class="hidden mt-3 p-3 rounded-lg bg-red-50 text-red-600 text-sm text-center"></div>
      </section>

      <a href="room.html" class="block text-center text-sm text-slate-500 hover:text-slate-700">
        â† ë°© ëª©ë¡ìœ¼ë¡œ
      </a>
    </div>

    <!-- ëŒ€ê¸°ì‹¤ -->
    <div id="view-lobby" class="hidden space-y-4">
      <section class="card p-6">
        <div class="flex items-center justify-between mb-4">
          <h2 class="font-bold text-lg">ëŒ€ê¸°ì‹¤</h2>
          <div class="text-sm">
            <span id="count" class="font-bold text-indigo-600">0</span> / 8ëª…
          </div>
        </div>

        <div class="bg-slate-100 rounded-lg p-3 mb-4 text-center">
          <div class="text-xs text-slate-500">ë°© ì½”ë“œ</div>
          <div id="lobbyRoom" class="font-bold"></div>
        </div>

        <ul id="playerList" class="space-y-1 mb-4"></ul>

        <div id="waiting" class="text-center py-4">
          <div class="inline-block animate-spin w-6 h-6 border-2 border-indigo-600 border-t-transparent rounded-full mb-2"></div>
          <p class="text-sm text-slate-500">ë°©ì¥ì´ ê²Œì„ì„ ì‹œì‘í•  ë•Œê¹Œì§€ ëŒ€ê¸° ì¤‘...</p>
        </div>

        <div id="started" class="hidden text-center py-4">
          <div class="text-2xl mb-2">ğŸ‰</div>
          <p class="text-emerald-600 font-medium mb-3">ê²Œì„ì´ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤!</p>
          <button id="goGame" class="btn bg-emerald-600 hover:bg-emerald-700 text-white rounded-lg px-6 py-2">
            ê²Œì„ í™”ë©´ìœ¼ë¡œ ì´ë™
          </button>
        </div>

        <button id="btnLeave" class="btn w-full mt-4 bg-slate-100 hover:bg-slate-200 text-slate-600 rounded-lg px-4 py-2 text-sm">
          ë‚˜ê°€ê¸°
        </button>
      </section>
    </div>

  </div>

  <script>
    const $ = s => document.querySelector(s);
    const show = (sel, yes) => $(sel).classList.toggle('hidden', !yes);

    const params = new URLSearchParams(location.search);
    const roomId = params.get('room') || '';

    if (!roomId) {
      alert('ì˜ëª»ëœ ë§í¬ì…ë‹ˆë‹¤.');
      location.href = 'room.html';
    }

    $('#roomIdDisplay').textContent = roomId;

    const serverUrl = location.hostname === 'localhost' ? 'http://localhost:3000' : '';
    const socket = io(serverUrl, { reconnection: true, reconnectionDelay: 1000 });

    let myName = '';

    socket.on('connect', () => {
      $('#badge').textContent = 'ì—°ê²°ë¨';
      $('#badge').className = 'badge bg-emerald-100 text-emerald-700';
    });

    socket.on('disconnect', () => {
      $('#badge').textContent = 'ì—°ê²° ëŠê¹€';
      $('#badge').className = 'badge bg-red-100 text-red-600';
    });

    socket.on('error', ({ message }) => showError(message));

    // ì°¸ê°€
    $('#btnJoin').onclick = () => {
      const name = $('#playerName').value.trim();
      if (!name) {
        showError('ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”.');
        return;
      }
      myName = name;
      socket.emit('room:join', { roomId, playerName: name });
    };

    $('#playerName').onkeydown = (e) => {
      if (e.key === 'Enter') $('#btnJoin').click();
    };

    // ì°¸ê°€ ì™„ë£Œ
    socket.on('room:joined', ({ roomId, room, playerName, reconnected }) => {
      myName = playerName;
      sessionStorage.setItem('roomId', roomId);
      sessionStorage.setItem('playerName', playerName);

      show('#view-join', false);
      show('#view-lobby', true);
      $('#lobbyRoom').textContent = roomId;

      if (reconnected && room.started) {
        show('#waiting', false);
        show('#started', true);
      }

      updatePlayerList(room.players);
    });

    socket.on('room:updated', (room) => {
      updatePlayerList(room.players);
    });

    function updatePlayerList(players) {
      const ul = $('#playerList');
      ul.innerHTML = '';
      players.forEach(p => {
        const li = document.createElement('li');
        const isMe = p.name === myName;
        li.className = `flex items-center justify-between p-2 rounded-lg ${isMe ? 'bg-indigo-50' : 'bg-slate-50'}`;
        li.innerHTML = `
          <span>${p.name} ${isMe ? '<span class="text-xs text-indigo-500">(ë‚˜)</span>' : ''}</span>
          ${p.isHost ? '<span class="badge bg-amber-100 text-amber-700">ë°©ì¥</span>' : ''}
        `;
        ul.appendChild(li);
      });
      $('#count').textContent = players.length;
    }

    // ê²Œì„ ì‹œì‘
    socket.on('game:started', (room) => {
      show('#waiting', false);
      show('#started', true);

      $('#goGame').onclick = () => {
        location.href = `game.html?room=${encodeURIComponent(room.id)}&name=${encodeURIComponent(myName)}`;
      };

      // 2ì´ˆ í›„ ìë™ ì´ë™
      setTimeout(() => {
        location.href = `game.html?room=${encodeURIComponent(room.id)}&name=${encodeURIComponent(myName)}`;
      }, 2000);
    });

    // ë‚˜ê°€ê¸°
    $('#btnLeave').onclick = () => {
      socket.emit('room:leave');
      sessionStorage.clear();
      location.href = 'room.html';
    };

    socket.on('room:deleted', () => {
      alert('ë°©ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
      sessionStorage.clear();
      location.href = 'room.html';
    });

    function showError(msg) {
      const el = $('#errJoin');
      el.textContent = msg;
      el.classList.remove('hidden');
      setTimeout(() => el.classList.add('hidden'), 3000);
    }

    // í¬ì»¤ìŠ¤
    $('#playerName').focus();
  </script>
</body>
</html>
