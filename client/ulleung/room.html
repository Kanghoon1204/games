<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#f8fafc">
  <title>ìš¸ë¦‰ í•œ ì ‘ì‹œ - ë°©</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    * { font-family: 'Noto Sans KR', sans-serif; -webkit-tap-highlight-color: transparent; }
    .btn { transition: all 0.2s; }
    .btn:active { transform: scale(0.97); }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
    .card { background: white; border-radius: 1rem; box-shadow: 0 1px 3px rgba(0,0,0,0.08); }
    .input-focus:focus { outline: none; border-color: #6366f1; box-shadow: 0 0 0 3px rgba(99,102,241,0.1); }
    .badge { font-size: 0.7rem; padding: 0.25rem 0.5rem; border-radius: 9999px; }
    .loading { animation: pulse 1.5s infinite; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
  </style>
</head>
<body class="bg-slate-50 text-slate-900 min-h-screen">
  <div class="max-w-2xl mx-auto p-4 pb-8">

    <!-- í—¤ë” -->
    <header class="flex items-center justify-between py-4">
      <a href="../" class="flex items-center gap-2">
        <span class="text-2xl">ğŸ½ï¸</span>
        <h1 class="text-xl font-bold">ìš¸ë¦‰ í•œ ì ‘ì‹œ</h1>
      </a>
      <div id="badge" class="badge bg-slate-200 text-slate-600">ì—°ê²° ì¤‘...</div>
    </header>

    <!-- ë·°: ë¡œë¹„ (ë°© ëª©ë¡ + ìƒì„±) -->
    <div id="view-lobby" class="space-y-4">

      <!-- ë°© ëª©ë¡ -->
      <section class="card p-4">
        <div class="flex items-center justify-between mb-4">
          <h2 class="font-bold text-lg">ë°© ëª©ë¡</h2>
          <button id="btnRefresh" class="btn text-sm text-indigo-600 hover:text-indigo-800 flex items-center gap-1">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
            </svg>
            ìƒˆë¡œê³ ì¹¨
          </button>
        </div>

        <div id="roomsLoading" class="text-center py-8 text-slate-400 loading">
          ë°© ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
        </div>

        <div id="roomsEmpty" class="hidden text-center py-8">
          <div class="text-4xl mb-2">ğŸ </div>
          <p class="text-slate-500">ì…ì¥ ê°€ëŠ¥í•œ ë°©ì´ ì—†ìŠµë‹ˆë‹¤</p>
          <p class="text-slate-400 text-sm">ì•„ë˜ì—ì„œ ìƒˆ ë°©ì„ ë§Œë“¤ì–´ë³´ì„¸ìš”!</p>
        </div>

        <ul id="roomsList" class="space-y-2 hidden"></ul>
      </section>

      <!-- ìƒˆ ë°© ë§Œë“¤ê¸° -->
      <section class="card p-4">
        <h2 class="font-bold text-lg mb-4">ìƒˆ ë°© ë§Œë“¤ê¸°</h2>

        <div class="space-y-4">
          <div>
            <label class="text-sm text-slate-600 block mb-1">ë‹‰ë„¤ì„</label>
            <input id="hostName" type="text" placeholder="ì˜ˆ: íƒí—˜ê°€" maxlength="10"
              class="input-focus w-full border border-slate-200 rounded-lg px-4 py-3 text-base">
          </div>

          <div>
            <label class="text-sm text-slate-600 block mb-2">ì§„í–‰ ë°©ì‹</label>
            <div class="grid grid-cols-2 gap-2">
              <label class="relative">
                <input type="radio" name="mode" value="web" checked class="peer sr-only">
                <div class="peer-checked:border-indigo-500 peer-checked:bg-indigo-50 border-2 border-slate-200 rounded-lg p-3 cursor-pointer transition">
                  <div class="font-medium text-sm">ì›¹ ì „ìš©</div>
                  <div class="text-xs text-slate-500">ìƒí’ˆ ìë™</div>
                </div>
              </label>
              <label class="relative">
                <input type="radio" name="mode" value="board" class="peer sr-only">
                <div class="peer-checked:border-indigo-500 peer-checked:bg-indigo-50 border-2 border-slate-200 rounded-lg p-3 cursor-pointer transition">
                  <div class="font-medium text-sm">ë³´ë“œê²Œì„</div>
                  <div class="text-xs text-slate-500">ì¹´ë“œ ì‚¬ìš©</div>
                </div>
              </label>
            </div>
          </div>

          <button id="btnCreate" class="btn w-full bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg px-4 py-3 font-medium">
            ë°© ë§Œë“¤ê¸°
          </button>
        </div>

        <div id="errCreate" class="hidden mt-3 p-3 rounded-lg bg-red-50 text-red-600 text-sm"></div>
      </section>
    </div>

    <!-- ë·°: ë°©ì¥ ëŒ€ê¸°ì‹¤ -->
    <div id="view-host" class="hidden space-y-4">
      <section class="card p-4">
        <div class="flex items-center justify-between mb-2">
          <h2 class="font-bold text-lg">ëŒ€ê¸°ì‹¤</h2>
          <div class="text-sm text-slate-500">
            <span id="count" class="font-bold text-indigo-600">1</span> / 8ëª…
          </div>
        </div>

        <div class="bg-slate-100 rounded-lg p-3 mb-4">
          <div class="text-xs text-slate-500 mb-1">ë°© ì½”ë“œ</div>
          <div id="roomId" class="font-bold text-lg"></div>
        </div>

        <div class="mb-4">
          <div class="text-sm text-slate-600 mb-2">ì°¸ê°€ ë§í¬</div>
          <div class="flex gap-2">
            <input id="shareLink" readonly
              class="flex-1 bg-slate-100 border-0 rounded-lg px-3 py-2 text-sm text-slate-600">
            <button id="btnCopy" class="btn bg-slate-800 hover:bg-slate-900 text-white rounded-lg px-4 py-2 text-sm">
              ë³µì‚¬
            </button>
          </div>
        </div>

        <div class="mb-4">
          <div class="text-sm text-slate-600 mb-2">ì°¸ê°€ì</div>
          <ul id="waitList" class="space-y-1"></ul>
        </div>

        <div class="flex gap-2">
          <button id="btnStart" disabled
            class="btn flex-1 bg-indigo-600 hover:bg-indigo-700 disabled:bg-slate-300 text-white rounded-lg px-4 py-3 font-medium">
            ê²Œì„ ì‹œì‘ (3ëª… ì´ìƒ)
          </button>
          <button id="btnDelete" class="btn bg-red-100 hover:bg-red-200 text-red-600 rounded-lg px-4 py-3">
            ì‚­ì œ
          </button>
        </div>

        <p class="text-xs text-slate-400 mt-3 text-center">30ë¶„ ë‚´ ì‹œì‘í•˜ì§€ ì•Šìœ¼ë©´ ìë™ ì‚­ì œë©ë‹ˆë‹¤</p>
      </section>
    </div>

  </div>

  <script src="../firebase-config.js"></script>
  <script>
    const $ = s => document.querySelector(s);
    const show = (sel, yes) => $(sel).classList.toggle('hidden', !yes);

    const ITEMS = ['ì˜¤ì§•ì–´', 'ë…ë„ìƒˆìš°', 'í˜¸ë°•', 'ëª…ì´ë‚˜ë¬¼'];
    const randomItem = () => ITEMS[Math.floor(Math.random() * ITEMS.length)];

    let currentRoomId = null;
    let roomRef = null;
    let roomsRef = db.ref('rooms');

    // ì—°ê²° ìƒíƒœ í™•ì¸
    db.ref('.info/connected').on('value', (snap) => {
      if (snap.val() === true) {
        $('#badge').textContent = 'ì—°ê²°ë¨';
        $('#badge').className = 'badge bg-emerald-100 text-emerald-700';
      } else {
        $('#badge').textContent = 'ì—°ê²° ëŠê¹€';
        $('#badge').className = 'badge bg-red-100 text-red-600';
      }
    });

    // ë°© ëª©ë¡ ì‹¤ì‹œê°„ êµ¬ë…
    function subscribeRooms() {
      roomsRef.orderByChild('createdAt').on('value', (snap) => {
        show('#roomsLoading', false);
        const rooms = [];
        snap.forEach(child => {
          const room = child.val();
          if (!room.started && !room.gameOver) {
            rooms.push({ id: child.key, ...room });
          }
        });
        rooms.reverse(); // ìµœì‹ ìˆœ

        show('#roomsEmpty', rooms.length === 0);
        show('#roomsList', rooms.length > 0);

        const ul = $('#roomsList');
        ul.innerHTML = '';
        rooms.slice(0, 20).forEach(room => {
          const playerCount = Object.keys(room.players || {}).length;
          const li = document.createElement('li');
          li.className = 'flex items-center justify-between p-3 bg-slate-50 rounded-lg';
          li.innerHTML = `
            <div>
              <div class="font-medium">${room.id}</div>
              <div class="text-xs text-slate-500">${room.hostName} Â· ${room.boardMode ? 'ë³´ë“œê²Œì„' : 'ì›¹'}</div>
            </div>
            <div class="flex items-center gap-3">
              <span class="text-sm text-slate-500">${playerCount}/8</span>
              <button onclick="joinRoom('${room.id}')"
                class="btn bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg px-3 py-1.5 text-sm"
                ${playerCount >= 8 ? 'disabled' : ''}>ì…ì¥</button>
            </div>
          `;
          ul.appendChild(li);
        });
      });
    }

    subscribeRooms();

    window.joinRoom = (roomId) => {
      location.href = `join.html?room=${encodeURIComponent(roomId)}`;
    };

    $('#btnRefresh').onclick = () => {
      show('#roomsLoading', true);
      show('#roomsList', false);
      show('#roomsEmpty', false);
    };

    // ë°© ìƒì„±
    $('#btnCreate').onclick = async () => {
      const name = $('#hostName').value.trim();
      if (!name) {
        showError('ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”.');
        return;
      }

      const boardMode = $('input[name="mode"]:checked').value === 'board';

      // ë°© ID ìƒì„±
      let roomId = `${name}ì˜ë°©`;
      let idx = 2;
      let exists = true;

      while (exists) {
        const snap = await db.ref(`rooms/${roomId}`).once('value');
        if (!snap.exists()) {
          exists = false;
        } else {
          roomId = `${name}ì˜ë°©${idx++}`;
          if (idx > 99) roomId = `${name}ì˜ë°©${Date.now()}`;
        }
      }

      const playerId = generatePlayerId();
      const room = {
        id: roomId,
        hostName: name,
        hostId: playerId,
        boardMode,
        started: false,
        gameOver: false,
        round: 0,
        phase: 'choose',
        currentItem: '',
        createdAt: firebase.database.ServerValue.TIMESTAMP,
        players: {
          [playerId]: {
            id: playerId,
            name,
            balance: 1000000,
            hold: 0,
            items: [],
            readyPart: false,
            readyBid: false,
            willParticipate: null,
            joinedAt: firebase.database.ServerValue.TIMESTAMP
          }
        }
      };

      await db.ref(`rooms/${roomId}`).set(room);

      sessionStorage.setItem('roomId', roomId);
      sessionStorage.setItem('playerName', name);
      sessionStorage.setItem('playerId', playerId);

      currentRoomId = roomId;
      showHostView(roomId, room);
    };

    $('#hostName').onkeydown = (e) => {
      if (e.key === 'Enter') $('#btnCreate').click();
    };

    function showHostView(roomId, room) {
      show('#view-lobby', false);
      show('#view-host', true);

      $('#roomId').textContent = roomId;
      const joinUrl = `${location.origin}${location.pathname.replace('room.html', 'join.html')}?room=${encodeURIComponent(roomId)}`;
      $('#shareLink').value = joinUrl;

      // ë°© ì‹¤ì‹œê°„ êµ¬ë…
      if (roomRef) roomRef.off();
      roomRef = db.ref(`rooms/${roomId}`);

      roomRef.on('value', (snap) => {
        if (!snap.exists()) {
          alert('ë°©ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
          location.reload();
          return;
        }
        const room = snap.val();
        updateWaitList(room);

        // ê²Œì„ ì‹œì‘ë¨
        if (room.started) {
          const name = sessionStorage.getItem('playerName');
          location.href = `game.html?room=${encodeURIComponent(roomId)}&name=${encodeURIComponent(name)}`;
        }
      });

      // 30ë¶„ í›„ ìë™ ì‚­ì œ ì„¤ì •
      setTimeout(() => {
        roomRef.once('value', snap => {
          if (snap.exists() && !snap.val().started) {
            roomRef.remove();
          }
        });
      }, 30 * 60 * 1000);
    }

    function updateWaitList(room) {
      const players = Object.values(room.players || {});
      const ul = $('#waitList');
      ul.innerHTML = '';
      players.forEach(p => {
        const li = document.createElement('li');
        li.className = 'flex items-center justify-between p-2 bg-slate-50 rounded-lg';
        li.innerHTML = `
          <span>${p.name}</span>
          ${p.name === room.hostName ? '<span class="badge bg-amber-100 text-amber-700">ë°©ì¥</span>' : ''}
        `;
        ul.appendChild(li);
      });
      $('#count').textContent = players.length;
      $('#btnStart').disabled = players.length < 3;
      $('#btnStart').textContent = players.length < 3
        ? `ê²Œì„ ì‹œì‘ (${3 - players.length}ëª… ë” í•„ìš”)`
        : 'ê²Œì„ ì‹œì‘';
    }

    $('#btnCopy').onclick = async () => {
      try {
        await navigator.clipboard.writeText($('#shareLink').value);
        $('#btnCopy').textContent = 'ë³µì‚¬ë¨!';
        setTimeout(() => $('#btnCopy').textContent = 'ë³µì‚¬', 1500);
      } catch (e) {
        $('#shareLink').select();
        document.execCommand('copy');
        $('#btnCopy').textContent = 'ë³µì‚¬ë¨!';
        setTimeout(() => $('#btnCopy').textContent = 'ë³µì‚¬', 1500);
      }
    };

    $('#btnStart').onclick = async () => {
      if (!currentRoomId) return;

      const updates = {
        started: true,
        phase: 'choose',
        round: 0
      };

      // ì›¹ ëª¨ë“œë©´ ëœë¤ ì•„ì´í…œ
      const snap = await db.ref(`rooms/${currentRoomId}/boardMode`).once('value');
      if (!snap.val()) {
        updates.currentItem = randomItem();
      }

      await db.ref(`rooms/${currentRoomId}`).update(updates);
    };

    $('#btnDelete').onclick = async () => {
      if (confirm('ë°©ì„ ì‚­ì œí• ê¹Œìš”?')) {
        if (roomRef) roomRef.off();
        await db.ref(`rooms/${currentRoomId}`).remove();
        sessionStorage.clear();
        location.reload();
      }
    };

    function generatePlayerId() {
      return 'P' + Math.random().toString(36).substr(2, 9);
    }

    function showError(msg) {
      const el = $('#errCreate');
      el.textContent = msg;
      el.classList.remove('hidden');
      setTimeout(() => el.classList.add('hidden'), 3000);
    }
  </script>
</body>
</html>
