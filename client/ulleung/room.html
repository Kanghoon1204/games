<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>울릉 한 접시 - 방</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <style>
    .mono { font-variant-numeric: tabular-nums; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
  </style>
</head>
<body class="bg-slate-50 text-slate-900 min-h-screen">
  <div class="max-w-4xl mx-auto p-4 md:p-6 space-y-6">

    <header class="flex items-center justify-between">
      <h1 class="text-xl md:text-2xl font-bold">울릉 한 접시</h1>
      <span id="badge" class="text-xs px-2 py-1 rounded bg-slate-200">연결 중...</span>
    </header>

    <!-- 방 목록 -->
    <section id="view-list" class="bg-white rounded-xl shadow p-4 md:p-6">
      <div class="flex items-center justify-between mb-4">
        <h2 class="font-semibold">방 목록</h2>
        <button id="btnRefresh" class="btn bg-slate-200 hover:bg-slate-300 rounded px-3 py-2 text-sm">새로고침</button>
      </div>
      <div id="roomsEmpty" class="hidden text-sm text-slate-500 border rounded p-3">
        입장 가능한 방이 없습니다. 새로 만들어보세요!
      </div>
      <ul id="roomsList" class="grid gap-3 md:grid-cols-2"></ul>
    </section>

    <!-- 새 방 만들기 -->
    <section id="view-create" class="bg-white rounded-xl shadow p-4 md:p-6">
      <h2 class="font-semibold mb-4">새 방 만들기</h2>

      <label class="text-sm block mb-1">닉네임 (방장)</label>
      <input id="hostName" type="text" placeholder="예: 상회장"
        class="w-full border rounded px-3 py-2 mb-4" maxlength="20">

      <div class="mb-4 text-sm space-y-2">
        <div class="font-medium">진행 방식</div>
        <label class="flex items-center gap-2">
          <input type="radio" name="mode" value="board" checked>
          <span>보드게임 (방장이 상품 수동 등록)</span>
        </label>
        <label class="flex items-center gap-2">
          <input type="radio" name="mode" value="web">
          <span>웹 전용 (상품 자동 결정)</span>
        </label>
      </div>

      <button id="btnCreate" class="btn w-full bg-emerald-600 hover:bg-emerald-700 text-white rounded px-4 py-2">
        방 만들기
      </button>
      <div id="errCreate" class="hidden mt-3 p-3 rounded bg-rose-50 border border-rose-200 text-rose-700 text-sm"></div>
    </section>

    <!-- 방장 대기실 -->
    <section id="view-host" class="hidden bg-white rounded-xl shadow p-4 md:p-6">
      <div class="flex items-center justify-between mb-2">
        <h2 class="font-semibold">대기실: <span id="roomId" class="mono"></span></h2>
        <div class="text-sm">참가자 <span id="count" class="font-bold">1</span> / 8</div>
      </div>
      <div class="text-xs text-slate-600 mb-4" id="modeInfo"></div>

      <div class="grid md:grid-cols-2 gap-4">
        <div class="border rounded-lg p-4">
          <h3 class="font-semibold mb-2">참가 링크</h3>
          <div class="flex items-center gap-2">
            <input id="shareLink" class="w-full border rounded px-3 py-2 text-xs" readonly>
            <button id="btnCopy" class="btn bg-slate-800 text-white rounded px-3 py-2 text-sm">복사</button>
          </div>
          <p class="text-xs text-slate-500 mt-2">3명 이상이면 시작 가능</p>
        </div>

        <div class="border rounded-lg p-4">
          <h3 class="font-semibold mb-2">대기 중</h3>
          <ul id="waitList" class="space-y-2 text-sm"></ul>
        </div>
      </div>

      <div class="mt-4 flex items-center gap-2">
        <button id="btnStart" class="btn bg-indigo-600 text-white rounded px-4 py-2" disabled>시작하기</button>
        <button id="btnDelete" class="btn bg-rose-600 text-white rounded px-3 py-2 text-sm">방 삭제</button>
      </div>
      <div id="errHost" class="hidden mt-3 p-3 rounded bg-rose-50 border border-rose-200 text-rose-700 text-sm"></div>
    </section>

  </div>

  <script>
    const $ = s => document.querySelector(s);
    const show = (sel, yes) => $(sel).classList.toggle('hidden', !yes);

    // 서버 URL (개발: localhost, 배포: 같은 호스트)
    const serverUrl = location.hostname === 'localhost'
      ? 'http://localhost:3000'
      : location.origin;

    const socket = io(serverUrl);
    let currentRoomId = null;

    // 연결 상태
    socket.on('connect', () => {
      $('#badge').textContent = '연결됨';
      $('#badge').className = 'text-xs px-2 py-1 rounded bg-emerald-600 text-white';
      socket.emit('rooms:get');
    });

    socket.on('disconnect', () => {
      $('#badge').textContent = '연결 끊김';
      $('#badge').className = 'text-xs px-2 py-1 rounded bg-rose-600 text-white';
    });

    // 에러
    socket.on('error', ({ message }) => {
      alert(message);
    });

    // 방 목록
    socket.on('rooms:list', (rooms) => {
      const list = $('#roomsList');
      list.innerHTML = '';
      $('#roomsEmpty').classList.toggle('hidden', rooms.length > 0);

      rooms.forEach(room => {
        const li = document.createElement('li');
        li.className = 'border rounded-lg p-3';
        li.innerHTML = `
          <div class="flex items-center justify-between mb-2">
            <div>
              <div class="font-semibold mono">${room.id}</div>
              <div class="text-xs text-slate-500">방장: ${room.hostName}</div>
            </div>
            <div class="text-xs text-slate-500">${room.boardMode ? '보드게임' : '웹 전용'}</div>
          </div>
          <div class="flex items-center justify-between">
            <span class="text-sm">${room.playerCount} / ${room.maxPlayers}명</span>
            <button class="btn bg-indigo-600 text-white rounded px-3 py-1.5 text-sm"
              onclick="joinRoom('${room.id}')" ${room.playerCount >= 8 ? 'disabled' : ''}>입장</button>
          </div>
        `;
        list.appendChild(li);
      });
    });

    // 방 입장 버튼
    window.joinRoom = (roomId) => {
      location.href = `join.html?room=${encodeURIComponent(roomId)}`;
    };

    // 새로고침
    $('#btnRefresh').onclick = () => socket.emit('rooms:get');

    // 방 생성
    $('#btnCreate').onclick = () => {
      const hostName = $('#hostName').value.trim();
      if (!hostName) {
        showError('#errCreate', '닉네임을 입력하세요.');
        return;
      }

      const boardMode = $('input[name="mode"]:checked').value === 'board';
      socket.emit('room:create', { hostName, boardMode });
    };

    // 방 생성 완료
    socket.on('room:created', ({ roomId, room }) => {
      currentRoomId = roomId;
      sessionStorage.setItem('roomId', roomId);
      sessionStorage.setItem('playerName', room.hostName);

      show('#view-list', false);
      show('#view-create', false);
      show('#view-host', true);

      $('#roomId').textContent = roomId;
      $('#modeInfo').textContent = room.boardMode ? '보드게임 모드' : '웹 전용 모드';

      const joinUrl = `${location.origin}${location.pathname.replace('room.html', 'join.html')}?room=${encodeURIComponent(roomId)}`;
      $('#shareLink').value = joinUrl;

      updateWaitList(room.players);
    });

    // 방 상태 업데이트
    socket.on('room:updated', (room) => {
      updateWaitList(room.players);
    });

    function updateWaitList(players) {
      const ul = $('#waitList');
      ul.innerHTML = '';
      players.forEach((p, i) => {
        const li = document.createElement('li');
        li.className = 'border rounded px-3 py-2';
        li.textContent = `${i + 1}. ${p.name}`;
        ul.appendChild(li);
      });
      $('#count').textContent = players.length;
      $('#btnStart').disabled = players.length < 3;
    }

    // 링크 복사
    $('#btnCopy').onclick = async () => {
      try {
        await navigator.clipboard.writeText($('#shareLink').value);
        $('#btnCopy').textContent = '복사됨!';
        setTimeout(() => $('#btnCopy').textContent = '복사', 1500);
      } catch (e) {
        alert('복사 실패: ' + e.message);
      }
    };

    // 시작
    $('#btnStart').onclick = () => {
      socket.emit('game:start');
    };

    // 게임 시작됨
    socket.on('game:started', (room) => {
      const name = sessionStorage.getItem('playerName');
      location.href = `game.html?room=${encodeURIComponent(room.id)}&name=${encodeURIComponent(name)}`;
    });

    // 방 삭제
    $('#btnDelete').onclick = () => {
      if (confirm('방을 삭제할까요?')) {
        socket.emit('room:delete');
      }
    };

    // 방 삭제됨
    socket.on('room:deleted', () => {
      sessionStorage.clear();
      location.reload();
    });

    function showError(sel, msg) {
      const el = $(sel);
      el.textContent = msg;
      el.classList.remove('hidden');
      setTimeout(() => el.classList.add('hidden'), 3000);
    }

    // Enter 키로 방 생성
    $('#hostName').onkeydown = (e) => {
      if (e.key === 'Enter') $('#btnCreate').click();
    };
  </script>
</body>
</html>
